<!doctype html>
<meta charset=utf-8>
<title>London Bus Arrivals</title>
<meta name=viewport content="maximum-scale=1, width=device-width">

<link href=//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css rel=stylesheet>
<style>
	a, a:active, a:hover, a:visited {
		tap-highlight-color: transparent;
		-moz-tap-highlight-color: transparent;
		-webkit-tap-highlight-color: transparent;

		text-decoration: inherit;
		color: #0088cc;
	}

	body {
		font-size: 16px;
	}

	h1 {
		font-size: 24px;
	}

	h2 {
		font-size: 20px;
	}

	footer {
		margin-top: 24px;
	}

	#loading-container {
		margin-bottom: 20px;
	}

	.hidden {
		display: none;
	}

	a.toggled {
		color: #005580;
	}
</style>

<body class=container>
	<h1>Bus stops within 300 meters</h1>

	<div id=loading-container>
		<p id=loading>Loading...</p>
		<p id=toggle-all class=hidden><a href=#toggle-all>Toggle all</a></p>
	</div>

	<article id=content></article>

	<footer>
		<p>Made by <a href=http://beaumartinez.com/>Beau Martinez</a>. Data provided by TFL. Not affiliated with TFL.</p>
	</footer>

	<script src=//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0-rc.3/handlebars.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/fastclick/0.6.0/fastclick.min.js></script>

	<script id=stop-template type=text/html>
		<div class=stop>
			<h2 class=stop-title><a href=#toggle>{{> stopTitleTemplate }}</a></h2>

			<ol class=stop-arrivals>
				{{# arrivals }}
					{{> arrivalTemplate }}	
				{{/ arrivals }}
			</ol>
		</div>
	</script>

	<script id=stop-title-template type=text/html>
		{{ exampleArrival.stopName }} {{#if exampleArrival.stopCode }}({{ exampleArrival.stopCode }}){{/ if }}
	</script>

	<script id=arrival-template type=text/html>
		<li>{{ route }} to {{ destination }} ({{ eta }})</li>
	</script>

	<script>
		$(function() {
			FastClick.attach(document.body);

			var stopTitleTemplate = document.getElementById('stop-title-template').innerHTML;
			Handlebars.registerPartial('stopTitleTemplate', stopTitleTemplate);

			stopTitleTemplate = Handlebars.compile(stopTitleTemplate);

			var arrivalTemplate = document.getElementById('arrival-template').innerHTML;
			Handlebars.registerPartial('arrivalTemplate', arrivalTemplate);

			var stopTemplate = document.getElementById('stop-template').innerHTML;
			stopTemplate = Handlebars.compile(stopTemplate);

			navigator.geolocation.getCurrentPosition(function(geoposition) {
				$.ajax('/arrival-times/' + geoposition.coords.latitude + '/' + geoposition.coords.longitude + '/').done(function(responseArrivals) {
					var stopLookup = _.groupBy(responseArrivals, 'stopId');
					console.log(stopLookup);

					var stopIds = Object.getOwnPropertyNames(stopLookup);
					stopIds = stopIds.sort(function(a, b) {
						var aExample = stopLookup[a][0];
						var bExample = stopLookup[b][0];

						var aKey = stopTitleTemplate({
							exampleArrival: aExample,
						});
						var bKey = stopTitleTemplate({
							exampleArrival: bExample,
						});

						console.log(aKey);

						return aKey.localeCompare(bKey);
					});

					stopIds.forEach(function(stopId) {
						var arrivals = stopLookup[stopId];
						arrivals = _.sortBy(arrivals, 'eta');

						// Timeago ETAs
						arrivals.map(function(arrival) {
							var eta = moment(arrival.eta);
							eta = eta.fromNow(true);

							arrival.eta = eta;

							return arrival;
						});

						var exampleArrival = arrivals[0];

						var renderedTemplate = stopTemplate({
							exampleArrival: exampleArrival,
							arrivals: arrivals,
						});

						// Add template, hide loading, add attribution

						var loading = document.getElementById('loading');
						loading.classList.add('hidden');

						var content = document.getElementById('content');
						content.innerHTML += renderedTemplate;

						var toggleAll = document.getElementById('toggle-all');
						toggleAll.classList.remove('hidden');
					});
				}).fail(function(response) {
					var loading = document.getElementById('loading-container');
					loading.innerHTML = "Couldn't load bus arrival data. Please try again later."
				});
			});

			$('body').on('click', function(event) {
				if (event.target.hash == '#toggle') {
					event.preventDefault();

					event.target.classList.toggle('toggled');
					$(event.target.parentNode).siblings().toggle();	
				}
			});
				
			$('a[href=#toggle-all]').click(function(event) {
				event.preventDefault();

				$('a[href=#toggle]').click();
			});
		});
	</script>

	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-40686809-1', 'tflbuses.com');
		ga('send', 'pageview');
	</script>
</body>
