<!doctype html>
<meta charset=utf-8>
<title>TFL Bus Arrivals</title>
<meta name=viewport content="maximum-scale=1, width=device-width">

<style>
	.hidden {
		display: none;
	}
</style>

<body>
	<h1>TFL bus arrivals within 300 meters</h1>

	<div id=loading>
		<h2>Loading...</h2>
	</div>

	<article id=content></article>

	<footer id=attribution class=hidden>
		<p>Data provided by TFL</p>
	</footer>

	<script src=//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0-rc.3/handlebars.min.js></script>

	{% raw %}
		<script id=stop-template type=text/html>
			<h2>{{ stopName }} {{#if stopCode }}({{ stopCode }}){{/ if }}</h2>

			<ol>
				{{# arrivals }}
					{{> arrivalPartial }}	
				{{/ arrivals }}
			</ol>
		</script>

		<script id=arrival-partial type=text/html>
			<li>{{ route }} to {{ destination }} ({{ eta }})</li>
		</script>
	{% endraw %}

	<script>
		$(function() {
			var arrivalPartial = document.getElementById('arrival-partial').innerHTML;
			Handlebars.registerPartial('arrivalPartial', arrivalPartial);

			var stopTemplate = document.getElementById('stop-template').innerHTML;
			stopTemplate = Handlebars.compile(stopTemplate);

			navigator.geolocation.getCurrentPosition(function(geoposition) {
				$.ajax('/arrival-times/' + geoposition.coords.latitude + '/' + geoposition.coords.longitude + '/').done(function(responseArrivals) {
					var stopLookup = _.groupBy(responseArrivals, 'stopId');
					console.log(stopLookup);

					var stopIds = Object.getOwnPropertyNames(stopLookup);
					stopIds.sort(function(stopId) {
						return stopLookup[stopId].stopName + stopLookup[stopId].stopCode;
					});

					stopIds.forEach(function(stopId) {
						var arrivals = stopLookup[stopId];
						arrivals = _.sortBy(arrivals, 'eta');

						// Timeago ETAs
						arrivals.map(function(arrival) {
							var eta = moment(arrival.eta);
							eta = eta.fromNow(true);

							arrival.eta = eta;

							return arrival;
						});

						var exampleArrival = arrivals[0];
						var renderedTemplate = stopTemplate({
							stopName: exampleArrival.stopName,
							stopCode: exampleArrival.stopCode,
							arrivals: arrivals,
						});

						// Add template, hide loading, add attribution

						var loadingNode = document.getElementById('loading');
						loadingNode.classList.add('hidden');

						var contentNode = document.getElementById('content');
						contentNode.innerHTML += renderedTemplate;

						var attributionNode = document.getElementById('attribution');
						attributionNode.classList.remove('hidden');
					});
				});
			});
		});
	</script>
</body>
