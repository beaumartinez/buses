<script src=//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.1.0/jquery.timeago.min.js></script>

<script>
	$(function() {
		$.timeago.settings.allowFuture = true;

		navigator.geolocation.getCurrentPosition(function(geoposition) {
			$.ajax('/arrival-times/' + geoposition.coords.latitude + '/' + geoposition.coords.longitude + '/').done(function(responseArrivals) {
				var stopLookup = _.groupBy(responseArrivals, 'stopId');
				console.log(stopLookup);

				var stopIds = Object.getOwnPropertyNames(stopLookup);
				stopIds.forEach(function(stopId) {
					var arrivals = stopLookup[stopId];

					var exampleArrival = arrivals[0];

					document.write('<h1>' + exampleArrival.stopName + ' (' + exampleArrival.stopCode + ')</h1><ul>');
					arrivals.forEach(function(arrival) {
						document.write('<li>' + arrival.route + ' (' + $.timeago(new Date(arrival.eta)) + ')</l1>');
					});

					document.write('</ul>');
				});
			});
		});
	});
</script>
