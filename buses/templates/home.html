<!doctype html>
<meta charset=utf-8>
<title>TFL Bus Arrivals</title>
<meta name=viewport content="maximum-scale=1, width=device-width">

<body>
	<script src=//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.1.0/jquery.timeago.min.js></script>
	<script src=//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0-rc.3/handlebars.min.js></script>

	{% raw %}
		<script id=stop-template type=text/html>
			<h2>{{ stopName }} {{#if stopId }}({{ stopId }}){{/ if }}</h2>

			{{# arrivals }}
				{{> arrivalPartial }}	
			{{/ arrivals }}
		</script>

		<script id=arrival-partial type=text/html>
			<li>{{ route }} ({{ eta }})</li>
		</script>
	{% endraw %}

	<script>
		$(function() {
			$.timeago.settings.allowFuture = true;

			Handlebars.registerPartial('arrivalPartial', document.getElementById('arrival-partial').innerHTML);
			var stopTemplate = Handlebars.compile(document.getElementById('stop-template').innerHTML);

			navigator.geolocation.getCurrentPosition(function(geoposition) {
				$.ajax('/arrival-times/' + geoposition.coords.latitude + '/' + geoposition.coords.longitude + '/').done(function(responseArrivals) {
					var stopLookup = _.groupBy(responseArrivals, 'stopId');
					console.log(stopLookup);

					var stopIds = Object.getOwnPropertyNames(stopLookup);

					stopIds.forEach(function(stopId) {
						var arrivals = stopLookup[stopId];
						arrivals.map(function(arrival) {
							var newEta = new Date(arrival.eta);
							newEta = $.timeago(newEta);

							arrival.eta = newEta;

							return arrival;
						});

						var exampleArrival = arrivals[0];

						var renderedTemplate = stopTemplate({
							stopName: exampleArrival.stopName,
							stopCode: exampleArrival.stopCode,
							arrivals: arrivals,
						});

						document.body.innerHTML += renderedTemplate;
					});
				});
			});
		});
	</script>
</body>
